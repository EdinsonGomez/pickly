<div id="wrapper">
	<div id="sidenav-wrapper">
		<a href="#" id="closebtn">&times;</a>
		<ul id="sidenav-content">
			<li ng-hide="user"><a role="button" href="" ng-click="clickHome()" translate="pic.home"></a></li>
			<li ng-show="user"><a role="button" href="" ng-click="clickDashboard()" translate="pic.profile"></a></li>
			<li><a role="button" ng-href="datasheets/{{datasheet}}.pdf" target="blank" translate="pic.datasheet"></a></li>
			<li><a role="button" id="download" href="" translate="pic.download"></a></li>
			<div ng-hide="user">
				<li ng-repeat="option in remaining"><a role="button" href="{{option.url}}"><span class="fa fa-microchip fa-fw"></span> {{option.name}}</a></li>
			</div>
			<div ng-show="user">
				<li><a role="button" href="" ng-click="logout()" translate="pic.logout"></a></li>
			</div>
		</ul>
	</div>

	<div id="main-content-wrapper">
		<!-- Notificación
		<div class="alert alert-info" id="notification">
			<p class="text-center" translate="pic.notification"></p>
		</div> -->

		<nav class="navbar navbar-inverse">
			<div class="container-fluid">
				<!-- Mobile Display -->
				<div class="navbar-header">
					
					<a href="#" class="navbar-brand" id="toggle"><span class="fa fa-bars"></span></a>
					<a ng-hide="user" ng-href="datasheets/{{datasheet}}.pdf" class="navbar-brand" target="_blank" title="Datasheet">{{ pic | uppercase}}</a>
					<a href="" class="navbar-brand" ng-show="user">{{ currentProject.name | uppercase }}</a>
				</div>
				<!-- Nav elements -->
				<div id="pic_menu">
					<form class="navbar-form navbar-right">
						<div class="form-group" ng-show="user">
							<a href="" class="btn btn-default" translate="pic.save" ng-click="saveXml()"></a>
						</div>
					</form>
					<ul class="nav navbar-nav navbar-right">
	  				<li role="presentation" ng-class="{active:tabIsSelected(1)}"><a href ng-click="selectTab(1)" translate="pic.blocks-tab"></a></li>
	  				<li role="presentation" ng-class="{active:tabIsSelected(2)}"><a href ng-click="selectTab(2)" translate="pic.code-tab" id="test"></a></li>
					</ul>
				</div>
			</div>
		</nav>

		<div ng-show="user && currentProject.contributors.length">
			<div id="chat">Chat</div>
			<div id="chat-box">
			  		<div id="chat-bar">
			    		<p>{{ currentProject.name | uppercase }}</p>
			    		<span class="fa fa-close"></span>
			  		</div>
			  		<div id="chat-messages">
			    		<ul id="messages"></ul>
			  		</div>
			  		<div id="chat-input">
			    		<form action="">
			      		<input type="text" id="message" placeholder="Escribe tu mensaje aquí" autocomplete="off" />
			    		</form>
			  		</div>
			</div>
		</div>
			
		<div id="blocklyDiv" ng-show="tabIsSelected(1)">
			<xml id="toolbox">
				<category name="{{ categoria1 }}" colour="120">
					<block type="controls_if"></block>
					<block type="loop"></block>
					<block type="loop_for"></block>
					<block type="controls_whileUntil"></block>
					<block type="controls_flow_statements"></block>
					<block type="delay_block"></block>
				</category>
				<category name="{{ categoria2 }}" colour="160">
					<block type="text"></block>
				</category>		
				<category name="{{ categoria3 }}" colour="260">
					<block type="create_arr"></block>
					<block type="create_arr_size"></block>
					<block type="set_arr"></block>
					<block type="get_arr"></block>
					<block type="lists_length"></block>
				</category>
				<category name="{{ categoria4 }}" colour="230">
					<block type="math_number"></block>	
					<block type="math_arithmetic"></block>			
					<block type="math_modulo"></block>
				</category>
				<category name="{{ categoria5 }}" colour="210">
					<block type="logic_compare"></block>
					<block type="logic_operation"></block>
					<block type="logic_negate"></block>
					<block type="logic_boolean"></block>	
				</category>
				<category name="{{ categoria6 }}" colour="330">
					<block type="create_var"></block>
					<block type="set_var"></block>
					<block type="get_var"></block>
				</category>
				<category name="{{ categoria7 }}" colour="290">
					<block type="fun_create"></block>
					<block type="fun_exec"></block>
					<block type="fun_get"></block>
					<block type="fun_return"></block>
				</category>
				<sep></sep>
				<!-- Bloques propios del microcontrolador -->
				<category name="{{ categoria8 }}" colour="0">
					<block type="adc_done"></block>
					<block type="adc_read"></block>
					<block type="adc_channel_18"></block>
					<block type="adc_setup"></block>
					<block type="adc_ports_18"></block>
				</category>
				<category name="{{ categoria9 }}" colour="20">
					<block type="comm_send"></block>
					<block type="comm_receive"></block>
					<block type="comm_baud_rate"></block>
				</category>
				<category name="{{ categoria10 }}" colour="65">
					<block type="io_type"></block>
					<block type="io_tris"></block>
					<block type="io_get"></block>
					<block type="io_set"></block>		
					<block type="io_pin_set_18"></block>
					<block type="io_pin_get_18"></block>
				</category>
				<category name="Timers" colour="180">
					<category name="Timer 0">
						<block type="tmr_tmr0_get"></block>
						<block type="tmr_tmr0_set_18"></block>
						<block type="tmr_tmr0_setup_18"></block>
					</category>
					<category name="Timer 1">
						<block type="tmr_tmr1_get"></block>
						<block type="tmr_tmr1_set"></block>
						<block type="tmr_tmr1_setup"></block>
					</category>
					<category name="Timer 2">
						<block type="tmr_tmr2_get"></block>
						<block type="tmr_tmr2_set"></block>
						<block type="tmr_tmr2_setup"></block>
					</category>
					<category name="Timer 3">
						<block type="tmr_tmr3_get"></block>
						<block type="tmr_tmr3_set"></block>
						<block type="tmr_tmr3_setup"></block>
					</category>
				</category>
				<category name="{{ categoria12 }}" colour="85">
					<block type="int_enable"></block>
					<block type="int_timer0"></block>
					<block type="int_timer1"></block>
					<block type="int_timer2"></block>
					<block type="int_rb"></block>
					<block type="int_ext"></block>
					<block type="int_ad"></block>
					<block type="int_tbe"></block>
					<block type="int_rda"></block>
				</category>
				<category name="LCD" colour="105">
					<block type="lcd_init"></block>
					<block type="lcd_clear"></block>
					<block type="lcd_print"></block>
					<block type="lcd_move"></block>
				</category>
			</xml>
		</div>

		<!-- Panel de código -->
		<div ng-show="tabIsSelected(2)">
			<div class="panel">
				<pre id="codigo"></pre>
			</div>
		</div>
	</div>
</div>

<xml id="startBlocks">
	<block type="main_function"></block>
</xml>

<script>	
	var workspaceData = {
		toolbox: document.getElementById('toolbox'),
		trashcan: true,
		grid: {
			spacing: 20
		}
	}
	var xml = '';
	var xml_text = '';
  var dataType = { type: 'text/plain;charset=utf-8' }
	var filename = 'main.c'
	var blob = new Blob()
	var header;
	var devices = ['18F2455', '18F2550', '18F4455', '18F4550', '18LF2455', '18LF2550', '18LF4455', '18LF4550'];
	var device = window.location.pathname.slice(8).toUpperCase();
	if (devices.indexOf(device) != -1) {
		header = setHeader(device)
	} else {
		device = JSON.parse(window.sessionStorage.getItem('currentProject')).pic.slice(3)
		header = setHeader(device)
	}

	function setHeader(pic) {
		return "// No modifiques esta seccion, a menos que sepas lo que haces\n" + 
					 "// Do not modify this section at least you know what you are doing\n" +
					 "#include <" + pic + ".h>\n\n" + 
					 "#FUSES NOWDT\n" + 
					 "#FUSES WDT128\n" +
					 "#FUSES PLL12\n" +
					 "#FUSES CPUDIV4\n" +
					 "#FUSES USBDIV\n" +
					 "#FUSES XT\n" +
					 "#FUSES FCMEN\n" +
					 "#FUSES IESO\n" +
					 "#FUSES NOPUT\n" +
           "#FUSES NOBROWNOUT\n" +
					 "#FUSES BORV20\n" +
					 "#FUSES VREGEN\n" +
					 "#FUSES PBADEN\n" + 
					 "#FUSES LPT1OSC\n" + 
					 "#FUSES MCLR\n" +
					 "#FUSES STVREN\n" +
					 "#FUSES NOLVP\n" +
					 "#FUSES NOXINST\n" +
					 "#FUSES NODEBUG\n" +
					 "#FUSES NOPROTECT\n" +
					 "#FUSES NOCPB\n" +
			     "#FUSES NOCPD\n" +
					 "#FUSES NOWRT\n" +
					 "#FUSES NOWRTC\n" +
					 "#FUSES NOWRTB\n" +
					 "#FUSES NOWRTD\n" +
					 "#FUSES NOEBTR\n" +                   
					 "#FUSES NOEBTRB\n\n" +                  
					 "#use delay(crystal=20000000,  clock=5000000)\n" + 
					 '//====================================================================\n';
	}
	
	/*$('#notification').hide();
	$("#notification").click(closeIt);*/
	$(document).ready(whenReady);
	$('.langBlock').click(changeWorkspaceLanguage)
	$('#download').click(downloadCode)

	/* Propiedades CSS del workspace */
	$("#blocklyDiv").css("height", $(window).height() - $(".navbar").height());
	$("#codigo").css("height", $(window).height() - $(".navbar").height());

	/* Evento
	 * Detecta los cambios en el tamaño de la pantalla y cambia el tamaño del área de trabajo
	 */
	$(document).resize(responsive)
	$(window).resize(responsive)

	/* Inyección del workspace de Blockly */
	var workspace = Blockly.inject('blocklyDiv', workspaceData)
	/* Generación(real-time) y descarga de código */
	workspace.addChangeListener(myUpdateFunction);

	/*function closeIt () {
		$(this).slideUp(500);
	}*/

	/* Despliegue de barra de notificación y cierre total del modal*/

	function whenReady () {
		//$('#notification').delay(500).slideDown(500);
		$('body').removeClass('modal-open');
		$('.modal-backdrop').remove();
		$('#blocklyDiv').show();
	}

	/* Destrucción y restauración del workspace */
	function changeWorkspaceLanguage () {
		setTimeout(refresh, 0);
		function refresh () {
			workspace.dispose();
			workspace = Blockly.inject('blocklyDiv', workspaceData)
			var pre_xml = Blockly.Xml.textToDom(xml_text);
			Blockly.Xml.domToWorkspace(pre_xml, workspace);
		}
	}

	function responsive () {
		$("#blocklyDiv").innerHeight($(window).height() - $(".navbar").height());
		$(".panel").innerHeight($(window).height() - $(".navbar").height());
	}

	var room = window.location.pathname.slice(5)
	
	if (socket) socket.emit('set room', room)

	function myUpdateFunction (event) {
		var code = Blockly.JavaScript.workspaceToCode(workspace);
	  var codeArr = []
	  $('#codigo').html(code);
	  codeArr.push(header)
		codeArr.push(code)
		blob = new Blob(codeArr, dataType)
	  // Conversión de bloques a texto
	  if (event.type == Blockly.Events.UI || event.type == Blockly.Events.CREATE) return

	  xml = Blockly.Xml.workspaceToDom(workspace);
	  xml_text = Blockly.Xml.domToText(xml);

	  if (socket) {
		  socket.emit('new xml', xml_text)
			socket.on('rebuild workspace', function (xml) {
				Blockly.Events.disable()
				workspace.clear()
				var xmlData = Blockly.Xml.textToDom(xml)
				Blockly.Xml.domToWorkspace(xmlData, workspace)
				Blockly.Events.enable()
			})
	  }
	}


	function downloadCode (e) {
		e.preventDefault()
		saveAs(blob, filename, true)
	}

	$('#toggle').click(function (e) {
		e.preventDefault();
		$('#wrapper').toggleClass('toggled');
	});

	$('#closebtn').click(function (e) {
		e.preventDefault();
		$('#wrapper').toggleClass('toggled');
	});

	var projectComming = JSON.parse(window.sessionStorage.getItem('currentProject'))
	if (projectComming && projectComming.xml) {
		var xmlFromDb = Blockly.Xml.textToDom(projectComming.xml)
		Blockly.Xml.domToWorkspace(xmlFromDb, workspace)
	} else {
		/* Inicialización del bloque void main */
		Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);
	}

	$('#chat-box').hide()
	$('#chat').click(function() {
  	$(this).fadeOut(500)
  	$('#chat-box').fadeIn(500)
	})
	$('.fa.fa-close').click(function() {
  	$('#chat-box').fadeOut(500)
  	$('#chat').fadeIn(500)
	})
</script>